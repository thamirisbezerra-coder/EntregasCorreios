import React, { useState, useMemo, useEffect } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, 
  PieChart, Pie, Cell 
} from 'recharts';
import { 
  Upload, Package, Search, Truck, Users, 
  FileText, LayoutDashboard, AlertCircle, Download, X, ArrowUpRight, CheckCircle2,
  Filter, Calendar as CalendarIcon, MapPin, UserCheck, Search as SearchIcon, AlertTriangle,
  Menu, Plus, Save, Edit3, Clock, MoreHorizontal
} from 'lucide-react';

// --- Cores e Estilos ---
const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#ec4899'];

// --- Dados Iniciais ---
const INITIAL_DATA = [
  { data: '07/11/2025', remetente: 'RAMP EQUIPAMENTOS', transportadora: 'SEDEX', doc: 'AB666959085BR', entreguePara: 'Éder', setor: 'P&D CARNEOS', obs: 'Entregue sem a/c p/ Éder' },
  { data: '07/11/2025', remetente: 'INTERLINK', transportadora: 'PROPRIA', doc: '-', entreguePara: 'JÉSSICA SOUZA', setor: 'COMPRAS', obs: 'Entregue em mãos!' },
  { data: '07/11/2025', remetente: 'ERIC', transportadora: 'FEDEX', doc: '885638572482', entreguePara: 'MICHELLE MORAIS', setor: 'COMPRAS', obs: 'Entregue em mãos!' },
  { data: '07/11/2025', remetente: 'BRG SUPLEMENTOS', transportadora: 'SEDEX', doc: 'ab666358347br', entreguePara: '-', setor: 'LABORATÓRIO', obs: '' }, // Exemplo Pendente
  { data: '07/11/2025', remetente: 'INOV3 SOLUÇÕES', transportadora: 'SEDEX', doc: 'oy484899621br', entreguePara: 'Mateus Fernandez', setor: 'LABORATÓRIO', obs: 'Entregue Para Mateus Fernandez!' },
  { data: '07/11/2025', remetente: 'MM LABORATÓRIO', transportadora: 'PAC', doc: 'an158493911br', entreguePara: '-', setor: 'SEL', obs: '' }, // Exemplo Pendente
  { data: '02/01/2025', remetente: 'LUISA', transportadora: 'MOTOBOY', doc: '-', entreguePara: 'Paulo cunha', setor: 'P&D', obs: 'Entregue em mãos!' },
  { data: '01/10/2025', remetente: 'HUBEI XINGFA', transportadora: 'DHL', doc: '284910293', entreguePara: 'MARCELO PRAIA', setor: 'COMPRAS', obs: 'Entregue em mãos!' },
];

export default function App() {
  const [deliveries, setDeliveries] = useState(INITIAL_DATA);
  const [searchTerm, setSearchTerm] = useState('');
  const [activeTab, setActiveTab] = useState('list');
  const [dragActive, setDragActive] = useState(false);
  const [uploadStats, setUploadStats] = useState({ count: 0, show: false });
  const [quickFilter, setQuickFilter] = useState('ALL');
  const [monthFilter, setMonthFilter] = useState('ALL');
  
  // UI States
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingIndex, setEditingIndex] = useState(null); // Índice do item sendo editado
  
  const [newDeliveryForm, setNewDeliveryForm] = useState({
    data: new Date().toLocaleDateString('pt-BR'),
    remetente: '',
    transportadora: '',
    doc: '',
    entreguePara: '',
    setor: '',
    obs: ''
  });

  // --- Parser CSV ---
  const parseCSV = (text) => {
    const lines = text.split('\n');
    const newDeliveries = [];
    lines.forEach(line => {
      const cleanLine = line.trim();
      if (!cleanLine) return;
      if (cleanLine.match(/^\d{2} DE [A-ZÇ]+ \([A-Z]+\)/i)) return;
      if (cleanLine.toLowerCase().startsWith('entrega,nome')) return;
      const columns = cleanLine.split(',');
      if (columns[0] && columns[0].match(/\d{2}\/\d{2}\/\d{4}/)) {
        const cleanSetor = (columns[5]?.trim().toUpperCase() || 'GERAL').replace(/[.,]/g, '').replace(/\s+/g, ' '); 
        let cleanTransp = columns[2]?.trim().replace(/\*/g, '').replace('****', '') || 'NÃO INF.';
        if (cleanTransp.length < 2) cleanTransp = 'NÃO INF.';
        newDeliveries.push({
          data: columns[0]?.trim(),
          remetente: columns[1]?.trim().toUpperCase(),
          transportadora: cleanTransp,
          doc: columns[3]?.trim(),
          entreguePara: columns[4]?.trim() || '-',
          setor: cleanSetor,
          obs: columns.slice(6).join(' ').trim().replace(/"/g, '')
        });
      }
    });
    return newDeliveries;
  };

  const handleFileUpload = (e) => {
    const files = Array.from(e.target.files || e.dataTransfer.files);
    let totalNew = 0;
    const promises = files.map(file => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => resolve(parseCSV(event.target.result));
        reader.readAsText(file);
      }));
    Promise.all(promises).then(results => {
      const allNewData = results.flat();
      setDeliveries(prev => {
        const prevString = new Set(prev.map(d => JSON.stringify(d)));
        const uniqueNew = allNewData.filter(d => !prevString.has(JSON.stringify(d)));
        totalNew = uniqueNew.length;
        return [...prev, ...uniqueNew];
      });
      if (totalNew > 0) {
        setUploadStats({ count: totalNew, show: true });
        setTimeout(() => setUploadStats(prev => ({...prev, show: false})), 5000);
      }
    });
  };

  const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if (e.type === "dragenter" || e.type === "dragover") setDragActive(true); else if (e.type === "dragleave") setDragActive(false); };
  const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setDragActive(false); if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFileUpload(e); };

  // --- CRUD Entregas ---
  
  // Abrir modal para nova entrega
  const handleOpenNew = () => {
    setEditingIndex(null);
    setNewDeliveryForm({
      data: new Date().toLocaleDateString('pt-BR'),
      remetente: '',
      transportadora: '',
      doc: '',
      entreguePara: '',
      setor: '',
      obs: ''
    });
    setIsModalOpen(true);
  };

  // Abrir modal para edição
  const handleOpenEdit = (item, index) => {
    // Precisamos encontrar o índice real no array principal, pois a lista pode estar filtrada
    const realIndex = deliveries.findIndex(d => d === item);
    setEditingIndex(realIndex);
    setNewDeliveryForm({
      data: item.data,
      remetente: item.remetente,
      transportadora: item.transportadora,
      doc: item.doc,
      entreguePara: item.entreguePara === '-' ? '' : item.entreguePara, // Limpa se for placeholder
      setor: item.setor,
      obs: item.obs
    });
    setIsModalOpen(true);
  };

  const handleSaveDelivery = (e) => {
    e.preventDefault();
    const newEntry = {
      ...newDeliveryForm,
      remetente: newDeliveryForm.remetente.toUpperCase(),
      transportadora: newDeliveryForm.transportadora.toUpperCase() || 'NÃO INF.',
      setor: newDeliveryForm.setor.toUpperCase() || 'GERAL',
      doc: newDeliveryForm.doc || '-',
      entreguePara: newDeliveryForm.entreguePara || '-'
    };

    if (editingIndex !== null) {
      // Editando
      setDeliveries(prev => {
        const updated = [...prev];
        updated[editingIndex] = newEntry;
        return updated;
      });
    } else {
      // Criando novo
      setDeliveries(prev => [newEntry, ...prev]);
    }
    
    setIsModalOpen(false);
  };

  // --- Estilos ---
  const getCarrierStyle = (carrier) => {
    const c = carrier.toUpperCase();
    if (c.includes('SEDEX') || c.includes('CORREIOS')) return 'text-yellow-600 bg-yellow-50 border-yellow-100';
    if (c.includes('FEDEX')) return 'text-purple-600 bg-purple-50 border-purple-100';
    if (c.includes('DHL')) return 'text-red-600 bg-red-50 border-red-100';
    return 'text-slate-500 bg-slate-50 border-slate-100';
  };
  
  const getSectorStyle = (sector) => {
    const s = sector.toUpperCase();
    if (s.includes('LAB')) return 'text-teal-600 bg-teal-50';
    if (s.includes('COMPRAS') || s.includes('ADM')) return 'text-indigo-600 bg-indigo-50';
    if (s.includes('P&D')) return 'text-rose-600 bg-rose-50';
    return 'text-slate-500 bg-slate-100';
  };

  const getObsAlert = (obs) => {
    if (!obs) return null;
    const lowerObs = obs.toLowerCase();
    if (lowerObs.includes('sem a/c') || lowerObs.includes('entregue para') || lowerObs.includes('retirou') || lowerObs.includes('deixado em')) return 'alert';
    return 'normal';
  };

  // --- Cálculos & Filtros ---
  const stats = useMemo(() => {
    const total = deliveries.length;
    const sectorCount = {};
    const carrierCount = {};
    const monthCount = {};
    const monthMap = { '01': 'Jan', '02': 'Fev', '03': 'Mar', '04': 'Abr', '05': 'Mai', '06': 'Jun', '07': 'Jul', '08': 'Ago', '09': 'Set', '10': 'Out', '11': 'Nov', '12': 'Dez' };

    deliveries.forEach(d => {
      let s = d.setor || 'OUTROS';
      if (s.includes('LAB')) s = 'LABORATÓRIO';
      sectorCount[s] = (sectorCount[s] || 0) + 1;
      let t = d.transportadora;
      if (t.includes('SEDEX')) t = 'SEDEX';
      if (t.includes('DHL')) t = 'DHL';
      if (t.includes('FEDEX')) t = 'FEDEX';
      carrierCount[t] = (carrierCount[t] || 0) + 1;
      if(d.data) {
        const parts = d.data.split('/');
        if(parts.length >= 2) {
          const m = parts[1];
          const label = monthMap[m] || m;
          monthCount[label] = (monthCount[label] || 0) + 1;
        }
      }
    });

    const topSectors = Object.entries(sectorCount).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, value]) => ({ name, value }));
    const topCarriers = Object.entries(carrierCount).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, value]) => ({ name, value }));
    const monthOrder = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
    const chartData = monthOrder.filter(m => monthCount[m]).map(m => ({ name: m, value: monthCount[m] }));
    const availableMonths = Object.keys(monthCount).sort((a,b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));

    return { total, topSectors, topCarriers, chartData, availableMonths };
  }, [deliveries]);

  const filteredDeliveries = useMemo(() => {
    let data = deliveries;
    const monthMapReverse = { 'Jan':'01', 'Fev':'02', 'Mar':'03', 'Abr':'04', 'Mai':'05', 'Jun':'06', 'Jul':'07', 'Ago':'08', 'Set':'09', 'Out':'10', 'Nov':'11', 'Dez':'12' };

    if (monthFilter !== 'ALL') {
      const targetMonth = monthMapReverse[monthFilter];
      data = data.filter(d => {
        if(!d.data) return false;
        const parts = d.data.split('/');
        return parts[1] === targetMonth;
      });
    }

    if (quickFilter !== 'ALL') {
      data = data.filter(d => {
        if (quickFilter === 'LAB') return d.setor.includes('LAB');
        if (quickFilter === 'COMPRAS') return d.setor.includes('COMPRAS') || d.setor.includes('ADM');
        if (quickFilter === 'PD') return d.setor.includes('P&D');
        return true;
      });
    }

    const lowerSearch = searchTerm.toLowerCase();
    if (lowerSearch) {
      data = data.filter(d => Object.values(d).some(val => String(val).toLowerCase().includes(lowerSearch)));
    }
    
    return data.sort((a, b) => {
        const da = a.data.split('/').reverse().join('');
        const db = b.data.split('/').reverse().join('');
        return db.localeCompare(da);
    });
  }, [deliveries, searchTerm, quickFilter, monthFilter]);

  // Componente de Card Atualizado (Sem rotação no ícone de fundo)
  const StatCard = ({ icon: Icon, label, value, subtext, color = "blue", insight = false }) => (
    <div className={`relative overflow-hidden p-6 rounded-xl border shadow-sm transition-all duration-200 ${insight ? 'bg-gradient-to-br from-indigo-600 to-violet-700 text-white border-transparent' : 'bg-white border-slate-200 hover:shadow-md'}`}>
      {!insight ? (
        <>
          {/* Ícone grande ao fundo (Marca d'água) - ROTAÇÃO REMOVIDA */}
          <div className={`absolute -right-4 -top-4 opacity-[0.12] text-${color}-600 pointer-events-none`}>
             <Icon size={100} strokeWidth={1.5} />
          </div>

          <div className="relative z-10">
            <div className="flex items-center gap-2 mb-1">
                <span className={`text-[10px] font-bold text-${color}-600 bg-${color}-50 px-2 py-0.5 rounded uppercase tracking-wider border border-${color}-100`}>
                    {label}
                </span>
            </div>
            
            <h3 className="text-3xl font-bold text-slate-800 truncate tracking-tight" title={String(value)}>
                {value}
            </h3>
            
            <p className="text-xs text-slate-500 mt-2 font-medium flex items-center gap-1">
               {subtext}
            </p>
          </div>
        </>
      ) : (
        <div className="relative z-10 flex flex-col justify-center h-full">
            <div className="flex items-center gap-2 mb-2">
                <AlertCircle className="text-yellow-300 h-4 w-4" />
                <span className="text-[10px] font-bold text-indigo-100 uppercase tracking-wide">Insight</span>
            </div>
            <p className="text-sm leading-snug font-medium">
              O setor <strong className="text-white border-b border-indigo-400 pb-0.5">{value}</strong> é o maior recebedor ({subtext}).
            </p>
        </div>
      )}
    </div>
  );

  return (
    <div className="flex h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden relative">
      
      {/* Sidebar Lateral (Drawer) */}
      <div 
        className={`fixed z-40 h-full bg-slate-900 text-white shadow-2xl transition-transform duration-300 flex flex-col w-72
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}
      >
        <div className="p-6 border-b border-slate-700 flex justify-between items-center whitespace-nowrap">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50">
              <Package className="h-6 w-6 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold leading-tight">Logística</h1>
              <p className="text-xs text-slate-400 font-medium">Controle 2025</p>
            </div>
          </div>
          <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-white">
            <X size={20} />
          </button>
        </div>
        
        <nav className="flex-1 p-4 space-y-2 whitespace-nowrap">
          <button onClick={() => {setActiveTab('list'); setIsSidebarOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 font-medium ${activeTab === 'list' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20 translate-x-1' : 'text-slate-400 hover:bg-slate-800 hover:text-white hover:translate-x-1'}`}>
            <FileText size={20} />
            <span>Relatório Diário</span>
          </button>
          <button onClick={() => {setActiveTab('dashboard'); setIsSidebarOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 font-medium ${activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20 translate-x-1' : 'text-slate-400 hover:bg-slate-800 hover:text-white hover:translate-x-1'}`}>
            <LayoutDashboard size={20} />
            <span>Dashboard Gráfico</span>
          </button>
        </nav>

        <div className="p-6 border-t border-slate-800 whitespace-nowrap">
          <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50 backdrop-blur-sm">
            <p className="text-xs text-slate-400 mb-1 uppercase tracking-wider font-semibold">Total Geral</p>
            <p className="text-3xl font-bold text-white tracking-tight">{stats.total}</p>
          </div>
        </div>
      </div>

      {isSidebarOpen && (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-[1px] z-30 transition-opacity duration-300" onClick={() => setIsSidebarOpen(false)}></div>
      )}

      {/* Conteúdo Principal */}
      <main className="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-50/50 w-full">
        
        {/* Header */}
        <header className="bg-white border-b border-slate-200 px-4 md:px-6 py-4 flex justify-between items-center shadow-sm z-10 gap-4">
          <div className="flex items-center gap-3">
              <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors" title="Abrir Menu">
                <Menu size={24} />
              </button>
              
              <h2 className="text-xl font-bold text-slate-800 flex items-center gap-3 truncate">
                {activeTab === 'dashboard' ? 'Dashboard' : 'Relatório'}
                {monthFilter !== 'ALL' && <span className="hidden sm:inline-block bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded border border-blue-200">{monthFilter}</span>}
              </h2>
          </div>

          <div className="flex items-center gap-3">
              <button 
                onClick={handleOpenNew}
                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-sm transition-all active:scale-95"
              >
                <Plus size={18} />
                <span className="hidden sm:inline">Nova Entrega</span>
              </button>
          </div>
        </header>

        <div className="flex-1 overflow-auto p-4 md:p-6 lg:p-8 space-y-6">
          
          {/* Upload Area */}
          <div className={`relative border-2 border-dashed rounded-xl transition-all duration-200 flex items-center justify-between gap-4 cursor-pointer group bg-white ${dragActive ? 'border-blue-500 bg-blue-50 p-8' : 'border-slate-200 hover:border-blue-400 hover:bg-slate-50 p-3'}`} onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}>
            <input type="file" multiple accept=".csv" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleFileUpload} />
            <div className="flex items-center gap-3">
              <div className="bg-blue-50 p-2 rounded-full group-hover:bg-blue-100 transition-colors"><Upload className="h-4 w-4 text-blue-600" /></div>
              <p className="font-semibold text-slate-600 text-xs">Importar novo CSV</p>
            </div>
            {uploadStats.show && <div className="text-xs font-bold text-emerald-600 flex items-center gap-1"><CheckCircle2 size={14}/> +{uploadStats.count} registros</div>}
          </div>

          {activeTab === 'list' ? (
            <div className="space-y-4 animate-in fade-in duration-500">
              
              {/* Cards Metrics (Estilo Large Icon) */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                  <StatCard icon={Package} label="Total" value={stats.total} subtext="Entregas registradas" color="blue" />
                  <StatCard icon={Users} label="Setor Top" value={stats.topSectors[0]?.name || '-'} subtext={`${stats.topSectors[0]?.value || 0} recebimentos`} color="teal" />
                  <StatCard icon={Truck} label="Transp." value={stats.topCarriers[0]?.name || '-'} subtext={`${stats.topCarriers[0]?.value || 0} entregas`} color="orange" />
                  <StatCard insight value={stats.topSectors[0]?.name || '-'} subtext={`${stats.topSectors[0]?.value} items`} />
              </div>

              {/* Tabela de Relatório Clean */}
              <div className="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col h-[calc(100vh-320px)]">
                
                {/* Header da Tabela */}
                <div className="p-4 border-b border-slate-100 flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between bg-white">
                  <div className="relative w-full xl:w-96">
                    <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                    <input type="text" placeholder="Buscar por remetente, rastreio..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm focus:bg-white transition-colors" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                  </div>
                  
                  <div className="flex flex-col sm:flex-row gap-3 w-full xl:w-auto">
                    <div className="flex items-center bg-slate-50 border border-slate-200 rounded-lg px-2">
                        <CalendarIcon size={14} className="text-slate-400 ml-2" />
                        <select value={monthFilter} onChange={(e) => setMonthFilter(e.target.value)} className="bg-transparent text-sm font-medium text-slate-700 py-2 px-2 focus:outline-none cursor-pointer hover:text-blue-600">
                            <option value="ALL">Todos os Meses</option>
                            {stats.availableMonths.map(m => (
                                <option key={m} value={m}>{m}</option>
                            ))}
                        </select>
                    </div>

                    <div className="flex gap-2 overflow-x-auto pb-1 sm:pb-0 scrollbar-hide">
                        {['ALL', 'LAB', 'COMPRAS'].map((filter) => (
                            <button key={filter} onClick={() => setQuickFilter(filter)} className={`whitespace-nowrap px-4 py-2 rounded-lg text-xs font-semibold border transition-all ${quickFilter === filter ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>
                                {filter === 'ALL' ? 'Todos' : filter === 'LAB' ? 'Laboratório' : 'Compras'}
                            </button>
                        ))}
                    </div>
                  </div>
                </div>

                {/* Tabela Clean */}
                <div className="flex-1 overflow-auto bg-white">
                  <table className="w-full text-sm text-left">
                    <thead className="text-xs text-slate-400 uppercase tracking-wider font-semibold sticky top-0 z-10 bg-white border-b border-slate-100">
                      <tr>
                        <th className="px-6 py-4 bg-white">Info Principal</th>
                        <th className="px-6 py-4 bg-white">Remetente / Setor</th>
                        <th className="px-6 py-4 bg-white">Entrega</th>
                        <th className="px-6 py-4 bg-white">Observações</th>
                        <th className="px-6 py-4 bg-white w-10"></th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-50">
                      {filteredDeliveries.map((item, idx) => {
                        const obsAlert = getObsAlert(item.obs);
                        const isPending = item.entreguePara === '-' || !item.entreguePara;
                        
                        return (
                        <tr key={idx} className="hover:bg-slate-50 transition-colors group">
                          {/* Coluna 1: Data e Rastreio */}
                          <td className="px-6 py-4 align-top">
                            <div className="flex flex-col gap-1.5">
                                <span className="text-xs font-mono text-slate-400">{item.data}</span>
                                <div className="flex items-center gap-2">
                                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold border ${getCarrierStyle(item.transportadora)}`}>
                                        {item.transportadora}
                                    </span>
                                </div>
                                <span className="font-mono text-xs font-medium text-slate-700 truncate max-w-[140px]" title={item.doc}>
                                    {item.doc}
                                </span>
                            </div>
                          </td>

                          {/* Coluna 2: Remetente e Setor */}
                          <td className="px-6 py-4 align-top">
                             <div className="flex flex-col gap-1">
                                <div className="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition-colors">{item.remetente}</div>
                                <span className={`text-[10px] font-bold uppercase tracking-wide w-fit ${getSectorStyle(item.setor)} px-1.5 py-0.5 rounded`}>
                                    {item.setor}
                                </span>
                             </div>
                          </td>

                          {/* Coluna 3: Entregue Para (Status) */}
                          <td className="px-6 py-4 align-top">
                             {!isPending ? (
                               <div className="flex items-center gap-2 mt-1">
                                  <div className="bg-emerald-100 p-1.5 rounded-full text-emerald-600 shrink-0"><UserCheck size={14} /></div>
                                  <div>
                                    <p className="text-xs text-slate-400 font-medium">Recebido por</p>
                                    <p className="font-semibold text-slate-700 text-sm">{item.entreguePara}</p>
                                  </div>
                               </div>
                             ) : (
                               <div className="flex items-center gap-2 mt-1 opacity-60">
                                   <div className="bg-slate-100 p-1.5 rounded-full text-slate-400 shrink-0"><Clock size={14} /></div>
                                   <div>
                                     <p className="text-xs text-slate-400 font-medium">Status</p>
                                     <p className="font-semibold text-slate-500 text-sm italic">Pendente</p>
                                   </div>
                               </div>
                             )}
                          </td>

                          {/* Coluna 4: Observações */}
                          <td className="px-6 py-4 align-top">
                              {item.obs && (
                                  <div className={`mt-1 text-xs px-2 py-2 rounded border max-w-[200px] leading-relaxed ${
                                      obsAlert === 'alert' 
                                      ? 'bg-orange-50 text-orange-800 border-orange-100 font-medium' 
                                      : 'bg-slate-50 text-slate-500 border-slate-100 italic'
                                  }`}>
                                      {obsAlert === 'alert' && <AlertTriangle size={12} className="inline mr-1 mb-0.5 text-orange-500" />}
                                      {item.obs}
                                  </div>
                              )}
                          </td>

                          {/* Coluna 5: Ações */}
                          <td className="px-6 py-4 align-middle text-right">
                             <button 
                                onClick={() => handleOpenEdit(item, idx)}
                                className="p-2 rounded-full hover:bg-blue-50 text-slate-400 hover:text-blue-600 transition-all opacity-0 group-hover:opacity-100"
                                title="Editar Entrega"
                             >
                                <Edit3 size={18} />
                             </button>
                          </td>
                        </tr>
                      )})}
                      {filteredDeliveries.length === 0 && <tr><td colSpan="6" className="px-6 py-16 text-center text-slate-400">Nenhum registro encontrado.</td></tr>}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          ) : (
             <div className="space-y-6 animate-in fade-in duration-500 h-full flex flex-col">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                  <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 className="text-base font-bold text-slate-800 mb-6 flex items-center gap-2"><CalendarIcon size={18} className="text-slate-400"/> Fluxo Mensal</h3>
                    <div className="flex-1 min-h-0">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={stats.chartData}>
                          <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                          <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} dy={10} />
                          <YAxis axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 12}} />
                          <RechartsTooltip cursor={{fill: '#f8fafc'}} contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)'}} />
                          <Bar dataKey="value" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={40} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                  <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
                    <h3 className="text-base font-bold text-slate-800 mb-6 flex items-center gap-2"><PieChart size={18} className="text-slate-400"/> Por Setor</h3>
                    <div className="flex-1 min-h-0">
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie data={stats.topSectors} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                            {stats.topSectors.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} stroke="none" />))}
                          </Pie>
                          <RechartsTooltip />
                          <Legend verticalAlign="bottom" height={36} iconType="circle" wrapperStyle={{fontSize: '12px'}} />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </div>
             </div>
          )}
        </div>
      </main>

      {/* Modal Nova/Editar Entrega */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <h3 className="text-lg font-bold text-slate-800">
                {editingIndex !== null ? 'Editar Entrega' : 'Nova Entrega (Check-in)'}
              </h3>
              <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600 transition-colors">
                <X size={24} />
              </button>
            </div>
            
            <form onSubmit={handleSaveDelivery} className="p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 uppercase">Data</label>
                  <input required type="text" className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="DD/MM/AAAA" value={newDeliveryForm.data} onChange={e => setNewDeliveryForm({...newDeliveryForm, data: e.target.value})} />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 uppercase">Rastreio / Doc</label>
                  <input type="text" className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Código de Rastreio" value={newDeliveryForm.doc} onChange={e => setNewDeliveryForm({...newDeliveryForm, doc: e.target.value})} />
                </div>
              </div>

              <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 uppercase">Remetente</label>
                <input required type="text" className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Empresa ou Pessoa" value={newDeliveryForm.remetente} onChange={e => setNewDeliveryForm({...newDeliveryForm, remetente: e.target.value})} />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 uppercase">Transportadora</label>
                  <select className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={newDeliveryForm.transportadora} onChange={e => setNewDeliveryForm({...newDeliveryForm, transportadora: e.target.value})}>
                    <option value="">Selecione...</option>
                    <option value="SEDEX">Correios / Sedex</option>
                    <option value="PAC">Correios / PAC</option>
                    <option value="FEDEX">FedEx</option>
                    <option value="DHL">DHL</option>
                    <option value="JADLOG">Jadlog</option>
                    <option value="MOTOBOY">Motoboy</option>
                    <option value="OUTROS">Outros</option>
                  </select>
                </div>
                <div className="space-y-1">
                   <label className="text-xs font-semibold text-slate-500 uppercase">Setor</label>
                   <input required type="text" className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ex: Compras" value={newDeliveryForm.setor} onChange={e => setNewDeliveryForm({...newDeliveryForm, setor: e.target.value})} />
                </div>
              </div>

              <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 uppercase">
                    Entregue Para <span className="text-slate-300 font-normal normal-case">(Opcional no cadastro)</span>
                </label>
                <input type="text" className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome de quem recebeu (deixar vazio se pendente)" value={newDeliveryForm.entreguePara} onChange={e => setNewDeliveryForm({...newDeliveryForm, entreguePara: e.target.value})} />
              </div>

              <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 uppercase">Observações</label>
                <textarea className="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none h-20 resize-none" placeholder="Detalhes adicionais..." value={newDeliveryForm.obs} onChange={e => setNewDeliveryForm({...newDeliveryForm, obs: e.target.value})}></textarea>
              </div>

              <div className="pt-4 flex gap-3">
                <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 py-3 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium">Cancelar</button>
                <button type="submit" className="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2">
                  <Save size={18} /> {editingIndex !== null ? 'Atualizar' : 'Salvar Entrada'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}


